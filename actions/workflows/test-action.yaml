---
version: '2.0'

stackstorm_demo.test-action:
  input:
    - trigger_body
    - emails

  tasks:

    delegate:
      action: core.noop
      publish:
        trigger_details: "{{ _.trigger_body }}"
      on-success:
        - diagnose
        - blame

    diagnose:
      action: core.local
      input:
        cmd: >
          node index diagnose
        cwd: /opt/stackstorm/bin/stackstorm_demo_cli
      publish:
        diagnosis: "{{ task('diagnose').result.stdout }}"
      on-success:
        - notify

    blame:
      action: core.local
      input:
        cmd: >
          node index blame
        cwd: /opt/stackstorm/bin/stackstorm_demo_cli
      publish:
        blamed: "{{ task('blame').result.stdout }}"
      on-success:
        - notify

    notify:
      action: core.sendmail
      with-items: email in {{ _.emails }}
      input:
        from: "mick@bitovi.com"
        to: "{{ _.email }}"
        subject: "Alert for location {{ _.trigger_body.details.location }} ({{ _.trigger_body.alertId }})"
        body: >
          We received an alert for location {{ _.trigger_body.details.location }} <br>
          Alert Id: ({{ _.trigger_body.alertId }})<br>
          