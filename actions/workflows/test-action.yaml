---
version: '2.0'

stackstorm_demo.test-action:
  input:
    - trigger_body
    - emails

  tasks:

    delegate:
      action: core.noop
      publish:
        trigger_details: "{{ _.trigger_body }}"
      on-success:
        - diagnose
        - blame

    diagnose:
      action: core.local
      input:
        cmd: >
          node index diagnose
        cwd: /opt/stackstorm/bin/stackstorm_demo_cli
      publish:
        diagnosis: "{{ task('diagnose').result.stdout }}"
      on-success:
        - notify

    blame:
      action: core.local
      input:
        cmd: >
          node index blame
        cwd: /opt/stackstorm/bin/stackstorm_demo_cli
      publish:
        blamed: "{{ task('blame').result.stdout }}"
      on-success:
        - notify

    notify:
      action: core.sendmail
      join: all
      with-items: email in {{ _.emails }}
      input:
        from: "mick@bitovi.com"
        to: "{{ _.email }}"
        subject: "Alert for location {{ _.trigger_body.details.location }} ({{ _.trigger_body.alertId }})"
        body: >
          We received an alert for location {{ _.trigger_body.details.location }} <br>
          Alert Id: ({{ _.trigger_body.alertId }})<br>
          <br />
          <b>Diagnosis:</b>
          {{ _.diagnosis.description }}<br>
          <table>
            <thead>
              <tr>
                <th>
                Key
                </th>
                <th>
                Description
                </th>
              </tr>
            </thead>
            <tbody>
              {% for key,val in _.diagnosis.items() %}
                {% if key != "description" %}
                  <tr>
                    <td>
                      {{ key }}
                    </td>
                    <td>
                      {% if val.items %}
                        {{ val.items.description}}<br>
                        {{ val.items["$ref"] }}
                      {% else %}
                        {{ val.description }}
                      {% endif %}
                    </td>
                  </tr>
                {% endif %}
              {% endfor %}
            </tbody>
          </table>
          <br><br>
          <b>Recent Orders</b>
          Address: {{ _.blamed.data.address }}<br>
          Date: {{ _.blamed.data.registered }}<br>
          <table>
            <thead>
              <tr>
                <th>
                  Name
                </th>
                <th>
                  Company
                </th>
                <th>
                  Phone                
                </th>
                <th>
                  Summary
                </th>
                <th>
                  Work Order Number
                </th>
              </tr>
            </thead>
            <tbody>
              {% for order in _.blamed.data.recent_orders %}
                  <tr>
                    <td>
                      {{ order.name }}
                    </td>
                    <td>
                      {{ order.company }}
                    </td>
                    <td>
                      {{ order.phone_number }}
                    </td>
                    <td>
                      {{ order.summary }}
                    </td>
                    <td>
                      {{ order.work_order_number }}
                    </td>
                  </tr>
              {% endfor %}
            </tbody>
          </table>